{% extends "base.html" %}

{% block title %}Oxygen Status - Hospital Management{% endblock %}
{% block page_title %}Oxygen Management{% endblock %}

{% block dashboard_content %}
<!-- Oxygen Overview Cards -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
    <!-- Available Cylinders -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 card-hover">
        <div class="flex items-center">
            <div class="p-3 rounded-full bg-cyan-100">
                <i class="fas fa-lungs text-cyan-600 text-xl"></i>
            </div>
            <div class="ml-4">
                <p class="text-sm font-medium text-gray-600">Available</p>
                <p class="text-2xl font-bold text-cyan-600">{{ oxygen.cylinders_in_stock if oxygen else 0 }}</p>
                <p class="text-xs text-gray-500">Cylinders</p>
            </div>
        </div>
    </div>

    <!-- In Use Cylinders -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 card-hover">
        <div class="flex items-center">
            <div class="p-3 rounded-full bg-orange-100">
                <i class="fas fa-fire text-orange-600 text-xl"></i>
            </div>
            <div class="ml-4">
                <p class="text-sm font-medium text-gray-600">In Use</p>
                <p class="text-2xl font-bold text-orange-600">{{ oxygen.cylinders_in_use if oxygen else 0 }}</p>
                <p class="text-xs text-gray-500">Cylinders</p>
            </div>
        </div>
    </div>

    <!-- Usage Percentage -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 card-hover">
        <div class="flex items-center">
            <div class="p-3 rounded-full bg-purple-100">
                <i class="fas fa-percentage text-purple-600 text-xl"></i>
            </div>
            <div class="ml-4">
                <p class="text-sm font-medium text-gray-600">Usage Rate</p>
                <p class="text-2xl font-bold text-purple-600">{{ "%.1f"|format(usage_percentage) }}%</p>
                <p class="text-xs text-gray-500">Current</p>
            </div>
        </div>
    </div>

    <!-- Days to Refill -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 card-hover">
        <div class="flex items-center">
            <div class="p-3 rounded-full bg-green-100">
                <i class="fas fa-calendar-alt text-green-600 text-xl"></i>
            </div>
            <div class="ml-4">
                <p class="text-sm font-medium text-gray-600">Next Refill</p>
                <p class="text-2xl font-bold text-green-600">{{ days_to_refill }}</p>
                <p class="text-xs text-gray-500">Days</p>
            </div>
        </div>
    </div>
</div>

<!-- Oxygen Usage Chart and Quick Actions -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
    <!-- Usage Chart -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Oxygen Distribution</h3>
        <div class="relative h-64">
            <canvas id="oxygenChart"></canvas>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Quick Actions</h3>
        <div class="space-y-4">
            <button onclick="updateStock()" class="w-full flex items-center justify-center px-4 py-3 bg-cyan-600 text-white rounded-lg hover:bg-cyan-700 transition-colors">
                <i class="fas fa-plus mr-2"></i>
                Update Stock Count
            </button>
            
            <button onclick="scheduleRefill()" class="w-full flex items-center justify-center px-4 py-3 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors">
                <i class="fas fa-calendar-plus mr-2"></i>
                Schedule Refill
            </button>
            
            <button onclick="reportIssue()" class="w-full flex items-center justify-center px-4 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
                <i class="fas fa-exclamation-triangle mr-2"></i>
                Report Issue
            </button>
            
            <button onclick="viewHistory()" class="w-full flex items-center justify-center px-4 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors">
                <i class="fas fa-history mr-2"></i>
                View History
            </button>
        </div>
    </div>
</div>

<!-- Patients Requiring Oxygen -->
<div class="bg-white rounded-xl shadow-sm border border-gray-200 mb-8">
    <div class="px-6 py-4 border-b border-gray-200">
        <div class="flex items-center justify-between">
            <h3 class="text-lg font-semibold text-gray-900">Patients Requiring Oxygen</h3>
            <span class="px-3 py-1 bg-orange-100 text-orange-800 rounded-full text-sm font-medium">
                {{ oxygen_patients|length }} Patients
            </span>
        </div>
    </div>
    
    {% if oxygen_patients %}
    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Patient</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ward</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Bed</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Flow Rate</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Duration</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for patient, bed, ward in oxygen_patients %}
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="w-10 h-10 bg-orange-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-user text-orange-600"></i>
                            </div>
                            <div class="ml-4">
                                <div class="text-sm font-medium text-gray-900">{{ patient.name }}</div>
                                <div class="text-sm text-gray-500">{{ patient.age }}y, {{ patient.gender.title() }}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">{{ ward.name }}</div>
                        <div class="text-sm text-gray-500">{{ ward.type.title() }}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                        {{ bed.bed_number }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                            {{ patient.oxygen_flow_rate or 'Not Set' }} L/min
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        Since admission
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <div class="flex space-x-2">
                            <button onclick="adjustFlow({{ patient.id }})" class="text-blue-600 hover:text-blue-900">
                                <i class="fas fa-sliders-h" title="Adjust Flow"></i>
                            </button>
                            <button onclick="viewPatientDetails({{ patient.id }})" class="text-green-600 hover:text-green-900">
                                <i class="fas fa-eye" title="View Details"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="p-8 text-center">
        <i class="fas fa-lungs text-gray-400 text-4xl mb-4"></i>
        <p class="text-gray-500">No patients currently requiring oxygen</p>
    </div>
    {% endif %}
</div>

<!-- Oxygen Alerts -->
{% if oxygen %}
<div class="bg-white rounded-xl shadow-sm border border-gray-200">
    <div class="px-6 py-4 border-b border-gray-200">
        <h3 class="text-lg font-semibold text-gray-900">System Alerts</h3>
    </div>
    <div class="p-6">
        <div class="space-y-4">
            {% if oxygen.cylinders_in_stock < 10 %}
            <div class="flex items-center p-4 bg-red-50 border border-red-200 rounded-lg">
                <i class="fas fa-exclamation-triangle text-red-600 mr-3"></i>
                <div>
                    <p class="font-medium text-red-800">Low Stock Alert</p>
                    <p class="text-sm text-red-600">Only {{ oxygen.cylinders_in_stock }} cylinders remaining in stock</p>
                </div>
            </div>
            {% endif %}
            
            {% if usage_percentage > 80 %}
            <div class="flex items-center p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                <i class="fas fa-warning text-yellow-600 mr-3"></i>
                <div>
                    <p class="font-medium text-yellow-800">High Usage Alert</p>
                    <p class="text-sm text-yellow-600">{{ "%.1f"|format(usage_percentage) }}% of oxygen cylinders are currently in use</p>
                </div>
            </div>
            {% endif %}
            
            {% if days_to_refill <= 3 %}
            <div class="flex items-center p-4 bg-blue-50 border border-blue-200 rounded-lg">
                <i class="fas fa-calendar-alt text-blue-600 mr-3"></i>
                <div>
                    <p class="font-medium text-blue-800">Refill Reminder</p>
                    <p class="text-sm text-blue-600">Next refill scheduled in {{ days_to_refill }} day{{ 's' if days_to_refill != 1 else '' }}</p>
                </div>
            </div>
            {% endif %}
            
            {% if oxygen.cylinders_in_stock >= 10 and usage_percentage <= 80 and days_to_refill > 3 %}
            <div class="flex items-center p-4 bg-green-50 border border-green-200 rounded-lg">
                <i class="fas fa-check-circle text-green-600 mr-3"></i>
                <div>
                    <p class="font-medium text-green-800">All Systems Normal</p>
                    <p class="text-sm text-green-600">Oxygen supply levels are adequate</p>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endif %}

<script>
// Initialize Oxygen Chart
document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('oxygenChart').getContext('2d');
    
    const inStock = {{ oxygen.cylinders_in_stock if oxygen else 0 }};
    const inUse = {{ oxygen.cylinders_in_use if oxygen else 0 }};
    
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Available', 'In Use'],
            datasets: [{
                data: [inStock, inUse],
                backgroundColor: ['#06B6D4', '#F97316'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
});

// Quick Action Functions
function updateStock() {
    const newStock = prompt('Enter new oxygen stock count:');
    if (newStock && !isNaN(newStock) && newStock >= 0) {
        showToast('Stock updated successfully', 'success');
        // Here you would typically send this to the server
    } else if (newStock !== null) {
        showToast('Please enter a valid number', 'error');
    }
}

function scheduleRefill() {
    const date = prompt('Enter refill date (YYYY-MM-DD):');
    if (date) {
        const dateRegex = /^\d{4}-\d{2}-\d{2}$/;
        if (dateRegex.test(date)) {
            showToast('Refill scheduled successfully', 'success');
            // Here you would typically send this to the server
        } else {
            showToast('Please enter date in YYYY-MM-DD format', 'error');
        }
    }
}

function reportIssue() {
    const issue = prompt('Describe the oxygen system issue:');
    if (issue && issue.trim()) {
        showToast('Issue reported successfully', 'success');
        // Here you would typically send this to the server
    }
}

function viewHistory() {
    showToast('Oxygen history feature coming soon', 'info');
}

function adjustFlow(patientId) {
    const flowRate = prompt('Enter new oxygen flow rate (L/min):');
    if (flowRate && !isNaN(flowRate) && flowRate > 0) {
        showToast('Flow rate updated successfully', 'success');
        // Here you would typically send this to the server
    } else if (flowRate !== null) {
        showToast('Please enter a valid flow rate', 'error');
    }
}

function viewPatientDetails(patientId) {
    showToast('Patient details feature coming soon', 'info');
}

// Toast notification
function showToast(message, type = 'success') {
    const toast = document.createElement('div');
    toast.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 text-white ${type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500'}`;
    toast.textContent = message;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, 3000);
}
</script>
{% endblock %}
